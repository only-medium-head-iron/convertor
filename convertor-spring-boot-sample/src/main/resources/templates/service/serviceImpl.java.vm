package ${serviceImplPackage};

import ${requestPackage}.${entityName}CreateReq;
import ${requestPackage}.${entityName}UpdateReq;
import ${requestPackage}.${entityName}PageQuery;
import ${responsePackage}.${entityName}RespVO;
import ${entityPackage}.${entityName};
import ${mapperPackage}.${entityName}Mapper;
import ${servicePackage}.${entityName}Service;
import com.mybatisflex.core.paginate.Page;
import com.mybatisflex.core.query.If;
import com.mybatisflex.core.query.QueryWrapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;
import javax.annotation.Resource;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

import static ${entityPackage}.table.AppConfigTableDef.APP_CONFIG;

/**
 * ${comment}服务实现
 */
@Slf4j
@Service
public class ${entityName}ServiceImpl implements ${entityName}Service {

    @Resource
    private ${entityName}Mapper ${entityVariable}Mapper;

    @Override
    public Page<${entityName}RespVO> pageQuery(${entityName}PageQuery query) {
        QueryWrapper queryWrapper = QueryWrapper.create()
                .select()
                .from(${tableConstantName})
                .where(${tableConstantName}.DELETED.eq(0))
        #foreach($column in $columns)
            #if(!$column.isPrimary && !$column.isLogicDelete && !$column.isTimestampField &&
                $column.name != "create_by" && $column.name != "update_by" &&
                $column.name != "create_time" && $column.name != "update_time")
                #if($column.name.endsWith("_name") || $column.name.endsWith("_title") ||
                    $column.name.endsWith("_remark") || $column.name.endsWith("_desc") ||
                    $column.name.endsWith("_description") || $column.name.endsWith("_key") ||
                    $column.name.endsWith("_value"))
                    .and(${tableConstantName}.${column.name.toUpperCase()}.like(query.get${column.propertyName.substring(0,1).toUpperCase()}${column.propertyName.substring(1)}(), If::hasText))
                #elseif($column.dataType == "int" || $column.dataType == "tinyint" || $column.dataType == "smallint" || $column.dataType == "bigint" || $column.dataType == "integer")
                    .and(${tableConstantName}.${column.name.toUpperCase()}.eq(query.get${column.propertyName.substring(0,1).toUpperCase()}${column.propertyName.substring(1)}(), If::notNull))
                #elseif($column.dataType == "varchar" || $column.dataType == "char" || $column.dataType == "text" || $column.dataType == "longtext" || $column.dataType == "mediumtext")
                    .and(${tableConstantName}.${column.name.toUpperCase()}.eq(query.get${column.propertyName.substring(0,1).toUpperCase()}${column.propertyName.substring(1)}(), If::hasText))
                #elseif($column.dataType == "decimal" || $column.dataType == "numeric" || $column.dataType == "float" || $column.dataType == "double")
                    .and(${tableConstantName}.${column.name.toUpperCase()}.eq(query.get${column.propertyName.substring(0,1).toUpperCase()}${column.propertyName.substring(1)}(), If::notNull))
                #elseif($column.dataType == "datetime" || $column.dataType == "timestamp" || $column.dataType == "date")
                    .and(${tableConstantName}.${column.name.toUpperCase()}.between(query.get${column.propertyName.substring(0,1).toUpperCase()}${column.propertyName.substring(1)}()))
                #elseif($column.dataType == "bit" || ($column.dataType == "tinyint" && $column.columnType.toLowerCase().contains("tinyint(1)")))
                    .and(${tableConstantName}.${column.name.toUpperCase()}.eq(query.get${column.propertyName.substring(0,1).toUpperCase()}${column.propertyName.substring(1)}(), If::notNull))
                #else
                    .and(${tableConstantName}.${column.name.toUpperCase()}.eq(query.get${column.propertyName.substring(0,1).toUpperCase()}${column.propertyName.substring(1)}(), If::notNull))
                #end
            #end
        #end;

        // 排序
        if (StringUtils.hasText(query.getSortField())) {
            if ("desc".equalsIgnoreCase(query.getSortOrder())) {
                queryWrapper.orderBy(${tableConstantName}.column(query.getSortField().toUpperCase()).desc());
            } else {
                queryWrapper.orderBy(${tableConstantName}.column(query.getSortField().toUpperCase()).asc());
            }
        } else {
            queryWrapper.orderBy(${tableConstantName}.CREATE_TIME.desc());
        }

        Page<${entityName}> page = ${entityVariable}Mapper.paginate(
                query.getPageNumber(),
                query.getPageSize(),
                queryWrapper
        );

        // 转换为VO
        List<${entityName}RespVO> voList = page.getRecords().stream()
                .map(this::convertToVO)
                .collect(Collectors.toList());

        Page<${entityName}RespVO> voPage = new Page<>();
        voPage.setPageNumber(page.getPageNumber());
        voPage.setPageSize(page.getPageSize());
        voPage.setTotalRow(page.getTotalRow());
        voPage.setRecords(voList);

        return voPage;
    }

    private ${entityName}RespVO convertToVO(${entityName} entity) {
        if (entity == null) {
            return null;
        }

            ${entityName}RespVO vo = new ${entityName}RespVO();
        BeanUtils.copyProperties(entity, vo);
        return vo;
    }
}